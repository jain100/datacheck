<!doctype html>
<html lang="en">
  <head>
    {% load staticfiles %}
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

    <link rel="stylesheet" href="{% static "style.css"%}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <link rel="icon" type="image/jpeg" href='{% static "Icon/logo.png" %}'>

    <title>Dashboarding Product | DizzData</title>

    <style type="text/css">
        .chart_type{
            width: 100%;
            padding-top: 10px;
            height: 50px;
            margin-top: 30px;
        }
        .chart_option{
            display: inline;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 2px;
            font-weight: 600;
            font-size: 18px;
        }
        #chart_variables_list{
            margin-top: 20px;
        }
        .file_list_item{
            padding: 0;
            margin: 0;
            width: 100%;
            font-weight: 400;
            color: #212529;
            text-align: inherit;
            white-space: nowrap;
            background-color: transparent;
            border: 0;
        }
        .file_list_item:hover{
            color: #5555ee;
        }
        .modal_menu_options{
            width: 250px;
            margin-top: 45vh;
            margin-left: auto;
            margin-right: auto;
        }
        .modal_label_inputs{
            width: 250px;
            margin-top: 45vh;
            margin-left: auto;
            margin-right: auto;
        }
        .label_input{
            border-collapse: collapse;
            margin-bottom: 5px;
            border-radius: 2px;
            border: 0.5px solid #cccccc;
            padding-left: 3px;
        }
        .main2 {
            margin: 0;
            background: white;
            height: 100%;
        }
        #chart_variables_list_x{
            width: 49%;
            float: left;
        }
        #chart_variables_list_y{
            width: 49%;
            float: right;
        }
        #chart_operations_list{
            width: 100%;
            float: left;
        }
        .checkbox_options_x{
            height: 16px;
          width: 16px;
          background-color: #eee;
        }
        .checkbox_options_y{
            height: 16px;
          width: 16px;
          background-color: #eee;
        }
        .checkbox_options_label_x{
            font-size: 14px;
            margin-left: 5px;
        }
        .checkbox_options_label_y{
            font-size: 14px;
            margin-left: 5px;
        }
        .checkbox_operations{
            height: 16px;
          width: 16px;
          background-color: #eee;
        }
        .checkbox_operations_label{
            font-size: 14px;
            margin-left: 5px;
        }
        input[type="radio"] {
          margin-top: -3px;
          vertical-align: middle;
        }
        #histBins{
            margin-top: 10px;
            float: left;
        }
        #change_bins_button{
            float: left;
        }
        #menu_icon{
            float: right;
            width: 24px;
            font-size: 24px;
            margin-right: 3px;
        }
        .dropdown-toggle2::after {
            display:none !important;
        }
        .website_name{
            padding: 0 20px;
            font-size: 24px;
            color: white;
        }
    </style>
  </head>
  <body>
     <form method="post" id="queryform" enctype="multipart/form-data">{% csrf_token %}</form>
    <section class="sec point" id="sec1">
        <div class="row">
            <div class="col-md-4 col-sm-4">
                <div class="website_name"><h2>Dizz Data</h2></div>
            </div>
            <div class="col-md-4 col-sm-4">
                <div class="dropdown">
                    <div class="point-center">
                        <button type="button" id="drop" class="btn dropdown-toggle" data-toggle="dropdown">
                            Files
                        </button>
                        <div class="dropdown-menu">
                            {% if documents %}
                              {% for document in documents %}
                                <form class="file_list_item" action="{% url 'docaccess' %}" method="post" enctype="multipart/form-data">
                                  {% csrf_token %}
                                  <label for="url"></label>
                                  <input id="url" type="hidden" name="url" value="{{ document.docfile.name }}">
                                  <button class="file_list_item" type="button" onclick="changeFileSubmit(event)">{{ document.docfile.name }}</button>
                                </form>
                              {% endfor %}
                            {% endif %}
                        </div>
                        
                    </div>
                </div>
            </div>
            
            <div class="col-md-4 col-sm-4">
                    <div class="dropdown">
                        <div class="point-center">
                            <button type="button" id="drop" class="btn dropdown-toggle" data-toggle="dropdown">
                                Connect to Database
                            </button>
                            <div class="dropdown-menu">
                                <a class="dropdown-item" href="{% url 'signin' %}">BigQuery</a>
                                <a class="dropdown-item" href="{% url 'uploadcsv' %}">Upload CSV</a>
                                {% if connected == True %}
                                  <a class="dropdown-item" href={% url 'logout' %}>Logout</a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
            </div>
        </div>
    </section>

    <section class="sec" id="sec2">

    </div>


        <div class="row">
            <div id="sec1-sql" class="col-md-2 col-sm-2">
                <div class="aside">
                    <ul class="list-group">
                        <a class="list-group-item" href="{% url 'root' %}">Coding Area </a>
                        <a class="list-group-item active" href="{% url 'charting' %}">Charting Area</a>
                        <a href="{% url 'staging' %}" class="list-group-item">Reporting Area</a>
                    </ul>
                </div>
            </div>
            <div class="col-md-3 col-sm-3" id="chart_variables_list">
                <div id="chart_variables_list_x"></div>
                <div id="chart_variables_list_y"></div>
                <div id="chart_operations_list"></div>
                <input type="text" name="histBins" id="histBins" placeholder="No. Of Columns" style="display: none;">
                <button type="button" id="change_bins_button" style="display: none;">Change Columns</button>
            </div>
            <div id="sec3-sql" class="col-md-7 col-sm-7">
                <div class="chart_type">
                    <div class="chart_option" id="bar_option" onclick="setGraphType('bar')">Bar Graph</div>
                    <div class="chart_option" id="histogram_option" onclick="setGraphType('histogram')">Histogram</div>
                    <div class="chart_option" id="pie_option" onclick="setGraphType('pie')">Pie Chart</div>
                    <div class="chart_option" id="line_option" onclick="setGraphType('line')">Line Graph</div>
                </div>

                <div class="main2" id="svgcontainer">
                    <div id="menu_icon" class="dropdown-toggle dropdown-toggle2" data-toggle="dropdown"><i class="fa fa-bars"></i> </div>
                    <ul class="dropdown-menu chartOptionsMenu" style="padding: 0;">
                        <li class="modal1Options"><button id="change_chart_labels_button" type="button" style="width: 158px;" 
                    class="btn btn-default" onclick="changeLabelsOptionSelected(event)">Change Labels</button></li>
                        <li class="modal1Options"><form action="{% url 'saveChartingGraph' %}"  name="saveChartingGraph" id="saveChartingGraph" method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        <input type="hidden" name="chartDataset" id="chartDataset" />
                        <input type="hidden" name="chartType" id="chartType" />
                        <input type="hidden" name="chartXAxisLabel" id="chartXAxisLabel" />
                        <input type="hidden" name="chartYAxisLabel" id="chartYAxisLabel" />
                        <input type="hidden" name="chartTitleSave" id="chartTitleSave" />
                        <input type="hidden" name="chartXAxisVar" id="chartXAxisVar" />
                        <input type="hidden" name="chartYAxisVar" id="chartYAxisVar" />
                        <input type="hidden" name="chartOp" id="chartOp" />
                        <input type="hidden" name="chartHist" id="chartHist" />
                        <input type="submit" style="width: 158px;" class="btn btn-success" value="Save"  />
                    </form></li>
                    <li class="modal2Options" style="display: none; width: 158px;"><input style="width: 158px;" class="label_input" type="text" name="chartTitle" id="chartTitle" placeholder="Chart Title"></li>
                    <br >
                    <li class="modal2Options" style="display: none; width: 158px;"><input style="width: 158px;"  class="label_input" type="text" name="xAxisLabel" id="xAxisLabel" placeholder="xAxisLabel"></li>
                    <br>
                    <li class="modal2Options" style="display: none; width: 158px;"><input style="width: 158px;"  class="label_input" type="text" name="yAxisLabel" id="yAxisLabel" placeholder="yAxisLabel"></li>
                    <br>
                    <li class="modal2Options" style="display: none; width: 158px;"><button style="width: 158px;"  type="button" class="btn btn-success" id="change_label_button" onclick="modal2OptionsClose(event)">Change Label</button></li>
                    <br>
                    <li class="modal2Options" style="display: none; width: 158px;"><button style="width: 158px;"  type="button" class="btn btn-default" id="change_label_button" onclick="modal2OptionsClose(event)">Close</button></li>
                    </ul>
                </div>
            </div>  


        </div>
    </section>

    <section>
        <div id="myModal2" class="modal fade modal_label_inputs" role="dialog">
            <div class="modal-dialog">
                <div class="modal-content">
                  <div class="modal-body">
                    <input class="label_input" type="text" name="chartTitle" id="chartTitle" placeholder="Chart Title">
                    <br>
                    <input class="label_input" type="text" name="xAxisLabel" id="xAxisLabel" placeholder="xAxisLabel">
                    <br>
                    <input class="label_input" type="text" name="yAxisLabel" id="yAxisLabel" placeholder="yAxisLabel">
                    <br>
                    <button type="button" class="btn btn-success" id="change_label_button" data-dismiss="modal">Change Label </button>
                    <br>
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                  </div>
                </div>
            </div>
        </div>
    </section>

    <section class="sec" id="sec3" style="margin-top: 30px;">
        <div class="row">
            <div class="col-md-9 col-sm-9">
                <div class="buttons">
                        <button type="button" class="btn btn-danger">Show Email Alerts</button>
                    </div>
            </div>
            <div class="col-md-3 col-sm-3">
                <div class="buttons">
                    <button type="button" class="btn btn-danger">Show Anamalies</button>
                </div>
            </div>
        </div>
    </section>
    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src='{% static "jquery-3.2.1.min.js" %}'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>

    <script src='{% static "script.js" %}'></script>

    

    <script src="https://d3js.org/d3.v4.min.js"></script>


    <script type="text/javascript">

        function changeFileSubmit(event){
            sessionStorage.setItem("barxAxisLabel","");
            sessionStorage.setItem("baryAxisLabel","");
            sessionStorage.setItem("barchartTitle","");

            sessionStorage.setItem("histxAxisLabel","");
            sessionStorage.setItem("histyAxisLabel","");
            sessionStorage.setItem("histchartTitle","");

            sessionStorage.setItem("piechartTitle","");

            sessionStorage.setItem("linexAxisLabel","");
            sessionStorage.setItem("lineyAxisLabel","");
            sessionStorage.setItem("linechartTitle","");

            sessionStorage.setItem("barXVar","");
            sessionStorage.setItem("barYVar","");
            sessionStorage.setItem("barOp","");

            sessionStorage.setItem("histXVar","");
            sessionStorage.setItem("globalHistBin","");

            sessionStorage.setItem("pieXVar","");
            sessionStorage.setItem("pieYVar","");
            sessionStorage.setItem("pieOp","");

            sessionStorage.setItem("lineXVar","");
            sessionStorage.setItem("lineYVar","");
            sessionStorage.setItem("lineOp","");
            

            sessionStorage.setItem("file_changing_process","true");
            event.target.parentNode.submit();
        }

        function changeLabelsOptionSelected(event){
            $('.modal2Options').css("display", "block");
            $('.modal1Options').css("display", "none");
            event.stopPropagation();
        }

        function modal2OptionsClose(event){
            $('.modal2Options').css("display", "none");
            $('.modal1Options').css("display", "block");
            event.stopPropagation();
        }


    var barxAxisLabel = "";
    if(sessionStorage.getItem("barxAxisLabel")){
        barxAxisLabel = sessionStorage.getItem("barxAxisLabel");
    }
    var baryAxisLabel = "";
    if(sessionStorage.getItem("baryAxisLabel")){
        baryAxisLabel = sessionStorage.getItem("baryAxisLabel");
    }
    var barchartTitle = "";
    if(sessionStorage.getItem("barchartTitle")){
        barchartTitle = sessionStorage.getItem("barchartTitle");
    }

    var histxAxisLabel = "";
    if(sessionStorage.getItem("histxAxisLabel")){
        histxAxisLabel = sessionStorage.getItem("histxAxisLabel");
    }
    var histyAxisLabel = "";
    if(sessionStorage.getItem("histyAxisLabel")){
        histyAxisLabel = sessionStorage.getItem("histyAxisLabel");
    }
    var histchartTitle = "";
    if(sessionStorage.getItem("histchartTitle")){
        histchartTitle = sessionStorage.getItem("histchartTitle");
    }

    var piechartTitle = "";
    if(sessionStorage.getItem("piechartTitle")){
        piechartTitle = sessionStorage.getItem("piechartTitle");
    }


    var linexAxisLabel = "";
    if(sessionStorage.getItem("linexAxisLabel")){
        linexAxisLabel = sessionStorage.getItem("linexAxisLabel");
    }
    var lineyAxisLabel = "";
    if(sessionStorage.getItem("lineyAxisLabel")){
        lineyAxisLabel = sessionStorage.getItem("lineyAxisLabel");
    }
    var linechartTitle = "";
    if(sessionStorage.getItem("linechartTitle")){
        linechartTitle = sessionStorage.getItem("linechartTitle");
    }

    var barXVar = sessionStorage.getItem("barXVar");
    var barYVar = sessionStorage.getItem("barYVar");
    var barOp = sessionStorage.getItem("barOp");

    var histXVar = sessionStorage.getItem("histXVar");
    var globalHistBin = "";
    if(sessionStorage.getItem("globalHistBin")){
        globalHistBin = sessionStorage.getItem("globalHistBin");
    }

    var pieXVar = sessionStorage.getItem("pieXVar");
    var pieYVar = sessionStorage.getItem("pieYVar");
    var pieOp = sessionStorage.getItem("pieOp");

    var lineXVar = sessionStorage.getItem("lineXVar");
    if(sessionStorage.getItem("lineYVar")){
        var lineYVar = (sessionStorage.getItem("lineYVar")).split(",");
    }else{
        var lineYVar = [];
    }
    var lineOp = sessionStorage.getItem("lineOp");

    window.onunload = function() {
        if (sessionStorage.getItem("file_changing_process") == "true"){
            sessionStorage.setItem("file_changing_process","false");
            return;
        }
        sessionStorage.setItem("barxAxisLabel",barxAxisLabel);
        sessionStorage.setItem("baryAxisLabel",baryAxisLabel);
        sessionStorage.setItem("barchartTitle",barchartTitle);

        sessionStorage.setItem("histxAxisLabel",histxAxisLabel);
        sessionStorage.setItem("histyAxisLabel",histyAxisLabel);
        sessionStorage.setItem("histchartTitle",histchartTitle);

        sessionStorage.setItem("piechartTitle",piechartTitle);

        sessionStorage.setItem("linexAxisLabel",linexAxisLabel);
        sessionStorage.setItem("lineyAxisLabel",lineyAxisLabel);
        sessionStorage.setItem("linechartTitle",linechartTitle);

        sessionStorage.setItem("barXVar",barXVar);
        sessionStorage.setItem("barYVar",barYVar);
        sessionStorage.setItem("barOp",barOp);

        sessionStorage.setItem("histXVar",histXVar);
        sessionStorage.setItem("globalHistBin",globalHistBin);

        sessionStorage.setItem("pieXVar",pieXVar);
        sessionStorage.setItem("pieYVar",pieYVar);
        sessionStorage.setItem("pieOp",pieOp);

        sessionStorage.setItem("lineXVar",lineXVar);
        sessionStorage.setItem("lineYVar",lineYVar.join(","));
        sessionStorage.setItem("lineOp",lineOp);

    }

    $('#saveChartingGraph').submit(function(){

        document.getElementById('chartDataset').value = working_dataset;
        document.getElementById('chartType').value = graph_type;

        if(graph_type=="bar"){
            document.getElementById('chartXAxisLabel').value = barxAxisLabel;
            document.getElementById('chartYAxisLabel').value = baryAxisLabel;
            document.getElementById('chartTitleSave').value = barchartTitle;

            document.getElementById('chartXAxisVar').value = barXVar;
            document.getElementById('chartYAxisVar').value = barYVar;
            document.getElementById('chartOp').value = barOp;
        }else if(graph_type=="histogram"){
            document.getElementById('chartXAxisLabel').value = histxAxisLabel;
            document.getElementById('chartYAxisLabel').value = histyAxisLabel;
            document.getElementById('chartTitleSave').value = histchartTitle;

            document.getElementById('chartXAxisVar').value = histXVar;
            document.getElementById('chartHist').value = globalHistBin;
        }else if(graph_type=="pie"){
            document.getElementById('chartXAxisLabel').value = "";
            document.getElementById('chartYAxisLabel').value = "";
            document.getElementById('chartTitleSave').value = piechartTitle;

            document.getElementById('chartXAxisVar').value = pieXVar;
            document.getElementById('chartYAxisVar').value = pieYVar;
            document.getElementById('chartOp').value = pieOp;
        }else if(graph_type=="line"){
            document.getElementById('chartXAxisLabel').value = linexAxisLabel;
            document.getElementById('chartYAxisLabel').value = lineyAxisLabel;
            document.getElementById('chartTitleSave').value = linechartTitle;

            document.getElementById('chartXAxisVar').value = lineXVar;
            document.getElementById('chartYAxisVar').value = lineYVar.join(",");
            document.getElementById('chartOp').value = lineOp;
        }

        return true;
    });


    var working_dataset = "static/{{request.session.working_dataset}}";
    var graph_type = "";

    var maxUniqueVar = "";
    var secondMaxUniqueVar = "";
    var maxUniqueVarCount=0;
    var secondMaxUniqueVarCount=0;

    $(document).ready(function(){
        
        d3.csv(working_dataset+'?' + Math.floor(Math.random() * 1000), function(error, data){
            var dataValues = d3.values(data)[0];
            for(var i=0; i<Object.keys(dataValues).length; i++ ){
                var newData = d3.nest()
                    .key(function(d) {return d[Object.keys(dataValues)[i]];})
                    .rollup(function(d) {
                    return d.length;
                    })
                .entries(data);
                if(newData.length > maxUniqueVarCount){
                    if(!$.isNumeric(newData[0].key)){
                        console.log(newData[0].key);
                        secondMaxUniqueVar = Object.keys(dataValues)[i];
                        secondMaxUniqueVarCount = newData.length;
                    }else{
                        if(maxUniqueVar != ""){
                            secondMaxUniqueVar = maxUniqueVar;
                            maxUniqueVar = Object.keys(dataValues)[i];
                            secondMaxUniqueVarCount = maxUniqueVarCount;
                            maxUniqueVarCount = newData.length;
                        }else{
                            maxUniqueVar = Object.keys(dataValues)[i];
                            maxUniqueVarCount = newData.length;
                        }
                    }
                }else if(newData.length > secondMaxUniqueVarCount){
                    secondMaxUniqueVar = Object.keys(dataValues)[i];
                    secondMaxUniqueVarCount = newData.length;
                }
            }
            console.log(maxUniqueVar +" : " + maxUniqueVarCount);
            console.log(secondMaxUniqueVar +" : " + secondMaxUniqueVarCount);
            setGraphType('bar');
        });
    });

    function setGraphType(x){

        graph_type = x;

        if(x=="bar") {

        document.getElementById('histBins').style.display = "none";
        document.getElementById('change_bins_button').style.display = "none";

        document.getElementById('bar_option').style.backgroundColor= "#cccccc";
        document.getElementById('histogram_option').style.backgroundColor= "#eaeaea";
        document.getElementById('pie_option').style.backgroundColor= "#eaeaea";
        document.getElementById('line_option').style.backgroundColor= "#eaeaea";


        d3.selectAll("svg").remove();
        d3.selectAll("select").remove();
        d3.selectAll("br").remove();
        d3.selectAll("input[type='radio']").remove();
        d3.selectAll("input[type='checkbox']").remove();
        d3.selectAll("h6").remove();
        d3.selectAll("label").remove();
        graphType = x;
        
        var margin = {top:0, right:0, bottom:20, left:50},
            width  = 900,
            height = 550;

        var svg = d3.select("#svgcontainer")
            .append("svg:svg")
            .attr("width", "100%")
            .attr("height", "100%")
            .attr("viewBox", "0 0 " + width + " " + height);


        var yScale = d3.scaleLinear()
            .range([height - margin.top - margin.bottom, 0]);

        var xScale = d3.scaleBand()
            .rangeRound([0, width - margin.right - margin.left])
            .paddingInner(0.5);

        var xAxis = d3.axisBottom(xScale);
        var yAxis = d3.axisLeft(yScale);
  

        var xAxisVar = barXVar;
        var yAxisVar = barYVar;
        var operation = barOp;


        if (xAxisVar == "" || xAxisVar == "null" || xAxisVar == null){
            xAxisVar = secondMaxUniqueVar;
            barXVar = secondMaxUniqueVar;
        }

        if(yAxisVar == "" || yAxisVar == "null" || yAxisVar == null){
            yAxisVar = maxUniqueVar;
            barYVar = maxUniqueVar;
        }

        if(operation == "" || operation == "null" || operation == null){
            operation = "Sum";
            barOp = "Sum";
        }
        d3.csv(working_dataset+'?' + Math.floor(Math.random() * 1000), function(error, data){

              var dataValues = d3.values(data)[0];

              var sLabel = d3.select('#change_label_button')
                        .text("Change Label");

                
                d3.select('#chart_variables_list').append('br');

                d3.select('#chart_variables_list_x')
                    .append('h6')
                    .text('X-Axis');

                d3.select('#chart_variables_list_y')
                    .append('h6')
                    .text('Y-Axis');

              for(var i=0; i<Object.keys(dataValues).length; i++ ){
                 d3.select('#chart_variables_list_x')
                    .append('input')
                        .attr('type','radio')
                        .attr('name', 'checkbox_options_x')
                        .attr("id",'xOption'+i)
                        .attr('class', 'checkbox_options_x')
                        .property('value', Object.keys(dataValues)[i]);

                 d3.select('#chart_variables_list_x')
                    .append('label')
                        .text(Object.keys(dataValues)[i])
                        .attr('class', 'checkbox_options_label_x')
                        .style('display', 'inline');
                 d3.select('#chart_variables_list_x')
                    .append('br');

              }

            d3.selectAll(("input[name='checkbox_options_x']")).on("change", function(){
                if(yAxisVar != this.value){
                    xAxisVar = this.value;
                    barXVar = xAxisVar;
                    if(barXVar!="null" && barYVar != "null" && barOp!="null"){
                        changeGraph(data, xAxisVar, yAxisVar, operation, barxAxisLabel, baryAxisLabel, barchartTitle);
                    }
                }else{
                    for(var i=0; i<Object.keys(dataValues).length; i++ ){
                        if(document.getElementById('xOption'+i).value == barXVar){
                            d3.select('#xOption'+i).property('checked', true);
                        }
                    }
                }
            });

            for(var i=0; i<Object.keys(dataValues).length; i++ ){
                if(document.getElementById('xOption'+i).value == barXVar){
                    d3.select('#xOption'+i).property('checked', true);
                    if(barXVar!="null" && barYVar != "null" && barOp!="null"){
                        changeGraph(data, xAxisVar, yAxisVar, operation, barxAxisLabel, baryAxisLabel, barchartTitle);
                    }
                }
            }

            for(var i=0; i<Object.keys(dataValues).length; i++ ){
                 d3.select('#chart_variables_list_y')
                    .append('input')
                        .attr('type','radio')
                        .attr('name', 'checkbox_options_y')
                        .attr("id",'yOption'+i)
                        .attr('class', 'checkbox_options_y')
                        .property('value', Object.keys(dataValues)[i]);

                 d3.select('#chart_variables_list_y')
                    .append('label')
                        .text(Object.keys(dataValues)[i])
                        .attr('class', 'checkbox_options_label_y')
                        .style('display', 'inline');
                 d3.select('#chart_variables_list_y')
                    .append('br');

              }

            d3.selectAll(("input[name='checkbox_options_y']")).on("change", function(){
                if(xAxisVar != this.value){
                    yAxisVar = this.value;
                    barYVar = yAxisVar;
                    if(barXVar!="null" && barYVar != "null" && barOp!="null"){
                        changeGraph(data, xAxisVar, yAxisVar, operation, barxAxisLabel, baryAxisLabel, barchartTitle);
                    }
                }else{
                    for(var i=0; i<Object.keys(dataValues).length; i++ ){
                        if(document.getElementById('yOption'+i).value == barYVar){
                            d3.select('#yOption'+i).property('checked', true);
                        }
                    }
                }
            });

            for(var i=0; i<Object.keys(dataValues).length; i++ ){
                if(document.getElementById('yOption'+i).value == barYVar){
                    d3.select('#yOption'+i).property('checked', true);
                    if(barXVar!="null" && barYVar != "null" && barOp!="null"){
                        changeGraph(data, xAxisVar, yAxisVar, operation, barxAxisLabel, baryAxisLabel, barchartTitle);
                    }
                }
            }


            d3.select('#chart_operations_list')
                    .append('h6')
                    .style('margin-top', '30px')
                    .text('Aggregation Function');

            var opArray = ['Sum', 'Average', 'Max', 'Min'];

            for(var i=0; i<4; i++){
                d3.select('#chart_operations_list').append('input')
                    .attr('type','radio')
                    .attr('name', 'checkbox_operations')
                    .attr('class', 'checkbox_operations')
                    .attr('id', 'barOpOption'+i)
                    .property('value',opArray[i]);
                d3.select('#chart_operations_list')
                        .append('label')
                            .text(opArray[i])
                            .attr('class', 'checkbox_operations_label')
                            .style('display', 'inline');
                 d3.select('#chart_operations_list').append('br'); 
            }


            d3.selectAll(("input[name='checkbox_operations']")).on("change", function(){
                operation = this.value;
                barOp = operation;
                if(barXVar!="null" && barYVar != "null" && barOp!="null"){
                    changeGraph(data, xAxisVar, yAxisVar, operation, barxAxisLabel, baryAxisLabel, barchartTitle);
                }
            });

            for(var i=0; i<4; i++ ){
                if(document.getElementById('barOpOption'+i).value == barOp){
                    d3.select('#barOpOption'+i).property('checked', true);
                    if(barXVar!="null" && barYVar != "null" && barOp!="null"){
                        changeGraph(data, xAxisVar, yAxisVar, operation, barxAxisLabel, baryAxisLabel, barchartTitle);
                    }
                }
            }


            sLabel.on('click', function(){
                if(graph_type == 'bar'){
                    barchartTitle = document.getElementById("chartTitle").value;
                    barxAxisLabel = document.getElementById("xAxisLabel").value;
                    baryAxisLabel = document.getElementById("yAxisLabel").value;
                    changeGraph(data, xAxisVar, yAxisVar, operation, barxAxisLabel, baryAxisLabel, barchartTitle);
                }
            });

        });

        function changeGraph(data, xAxisVar, yAxisVar, operation, xAxisLabel, yAxisLabel, chartTitle){
          d3.selectAll("svg > *").remove();

            var dataNew;
            if(operation == "Average") {
              dataNew=d3.nest()
                .key(function(d) {return d[xAxisVar];})
                .rollup(function(d) {
                return d3.mean(d,function(g) {return +g[yAxisVar];});
                })
                .entries(data);
            }else if(operation == "Sum") {
              dataNew=d3.nest()
                .key(function(d) {return d[xAxisVar];})
                .rollup(function(d) {
                return d3.sum(d,function(g) {return +g[yAxisVar];});
                })
                .entries(data);
            }else if(operation == "Max") {
              dataNew=d3.nest()
                .key(function(d) {return d[xAxisVar];})
                .rollup(function(d) {
                return d3.max(d,function(g) {return +g[yAxisVar];});
                })
                .entries(data);
            }else if(operation == "Min") {
              dataNew=d3.nest()
                .key(function(d) {return d[xAxisVar];})
                .rollup(function(d) {
                return d3.min(d,function(g) {return +g[yAxisVar];});
                })
                .entries(data);
            }

            dataNew.sort(function(x, y){
              return d3.ascending(+x["key"], +y["key"]);
            })
            
                

            yScale.domain([0, d3.max(dataNew, function(d){ return d["value"]; })]).nice();

            xScale.domain(dataNew.map(function(d){ return d["key"]; }));

            var colorScale = d3.scaleOrdinal(d3.schemeCategory10);
            colorScale.domain(data.map(function (d){ return d["key"]; }));

            var maxXAxisLabelWidth = d3.max(data, function(d){ return d[xAxisVar].length; });

            maxXAxisLabelWidth *= dataNew.length;


            svg.append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
            .selectAll(".bar")
            .data(dataNew)
            .enter().append("rect")
            .attr("class", "bar")
            .attr("x", function(d){ return xScale(d["key"]); })
            .attr("y", function(d){ return yScale(d["value"]); })
            .attr("fill", function (d){ return colorScale(d["key"]); })
        //    .attr("fill", "red")
            .attr("height", function(d){ return height - margin.top - margin.bottom - yScale(d["value"]); })
            .attr("width", xScale.bandwidth())
            .on("mouseout", function() { tooltip.style("display", "none"); })
            .on("mousemove", function(d) {
              var xPosition = d3.mouse(this)[0];
              var yPosition = d3.mouse(this)[1] - 25;
              tooltip.style("display", "block");
              tooltip.attr("transform", "translate(" + xPosition + "," + yPosition + ")");
              tooltip.select("text").text(+d["value"].toFixed(3));
            });

            if(xAxisLabel == ""){
                xAxisLabel = secondMaxUniqueVar;
                barxAxisLabel = secondMaxUniqueVar;
                
            }

            if(yAxisLabel == ""){
                yAxisLabel = maxUniqueVar;
                baryAxisLabel = maxUniqueVar;
            }

            if(chartTitle == ""){
                chartTitle = secondMaxUniqueVar + " vs " + maxUniqueVar;
                barchartTitle = secondMaxUniqueVar + " vs " + maxUniqueVar;
            }

            svg.append("g")
            .attr("class", "y axis")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
            .call(yAxis);

            svg.append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", 0)
                .attr("x", 0 - (height / 2))
                .attr("dy", "1em")
                .style("text-anchor", "middle")
                .text(yAxisLabel);

        //adding x axis to the bottom of chart


            if(maxXAxisLabelWidth > 100){
                svg.append("g")
                .attr("class", "x axis")
                .attr("transform", "translate(" + margin.left + "," + (height - margin.bottom) + ")")
                .call(xAxis)
                .selectAll("text")
                    .attr("y", 0)
                    .attr("x", 9)
                    .attr("dy", ".35em")
                    .attr("transform", "rotate(90)")
                    .style("text-anchor", "start");
            }else{
                svg.append("g")
                .attr("class", "x axis")
                .attr("transform", "translate(" + margin.left + "," + (height - margin.bottom) + ")")
                .call(xAxis);
            }


            svg.append("text")             
              .attr("transform","translate(" + (width/2) + " ," + (height + margin.top + 20) + ")")
              .style("text-anchor", "middle")
              .text(xAxisLabel);


            d3.select('svg').append("text")
                .attr("x", (width / 2))             
                .attr("y", -50)
                .attr("text-anchor", "middle")  
                .style("font-size", "16px") 
                .style("text-decoration", "underline")  
                .style("font-size", "24px")
                .style("font-weight", "bold")
                .text(chartTitle);

            var tooltip = svg.append("g")
            .style("display", "none");
              
            tooltip.append("rect")
            .attr("width", 60)
            .attr("height", 20)
            .attr("fill", "white")
            .style("opacity", 0.5);

            tooltip.append("text")
            .attr("x", 30)
            .attr("dy", "1.2em")
            .style("text-anchor", "middle")
            .attr("font-size", "12px")
            .attr("font-weight", "bold");
          }



    }else if(x == "histogram"){

        document.getElementById('histBins').style.display = "block";
        document.getElementById('change_bins_button').style.display = "block";

        document.getElementById('bar_option').style.backgroundColor= "#eaeaea";
        document.getElementById('histogram_option').style.backgroundColor= "#cccccc";
        document.getElementById('pie_option').style.backgroundColor= "#eaeaea";
        document.getElementById('line_option').style.backgroundColor= "#eaeaea";


        d3.select("svg").remove();
        d3.selectAll("select").remove();
        d3.selectAll("input[type='radio']").remove();
        d3.selectAll("input[type='checkbox']").remove();
        d3.selectAll("h6").remove();
        d3.selectAll("label").remove();
        d3.selectAll("br").remove();
        graphType = x;
        
        var margin = {top:0, right:0, bottom:20, left:50},
            width  = 900,
            height = 550;

        var svg = d3.select("#svgcontainer")
            .append("svg:svg")
            .attr("width", "100%")
            .attr("height", "100%")
            .attr("viewBox", "0 0 " + width + " " + height);


        var yScale = d3.scaleLinear()
            .range([height - margin.top - margin.bottom, 0]);

        var xScale = d3.scaleLinear()
            .rangeRound([0, width - margin.right - margin.left]);

        
  

        var xAxisVar = histXVar;
        if (xAxisVar == "" || xAxisVar == "null" || xAxisVar == null){
            xAxisVar = maxUniqueVar;
            histXVar = maxUniqueVar;
        }
        var binCount = globalHistBin;
        if(binCount == "" || binCount == "null" || binCount == null){
            binCount = "25";
            globalHistBin = "25";
        }


        d3.csv(working_dataset+'?' + Math.floor(Math.random() * 1000), function(error, data){

    

              var dataValues = d3.values(data)[0];


              var sLabel = d3.select('#change_label_button')
                        .text("Change Label");

                
                d3.select('#chart_variables_list').append('br');

              d3.select('#chart_variables_list_x')
                    .append('h6')
                    .text('X-Axis');

              for(var i=0; i<Object.keys(dataValues).length; i++ ){
                 d3.select('#chart_variables_list_x')
                    .append('input')
                        .attr('type','radio')
                        .attr('name', 'checkbox_options_x')
                        .attr("id",'xOption'+i)
                        .attr('class', 'checkbox_options_x')
                        .property('value', Object.keys(dataValues)[i]);

                 d3.select('#chart_variables_list_x')
                    .append('label')
                        .text(Object.keys(dataValues)[i])
                        .attr('class', 'checkbox_options_label_x')
                        .style('display', 'inline');
                 d3.select('#chart_variables_list_x')
                    .append('br');

              }

            d3.selectAll(("input[name='checkbox_options_x']")).on("change", function(){
                xAxisVar = this.value;
                histXVar = xAxisVar;
                if(histXVar!="null" && globalHistBin != ""){
                    changeHisto(data, xAxisVar, histxAxisLabel, histyAxisLabel, histchartTitle, binCount);
                }
            });

            for(var i=0; i<Object.keys(dataValues).length; i++ ){
                if(document.getElementById('xOption'+i).value == histXVar){
                    d3.select('#xOption'+i).property('checked', true);
                    if(histXVar!="null" && globalHistBin != ""){
                        changeHisto(data, xAxisVar, histxAxisLabel, histyAxisLabel, histchartTitle, binCount);
                    }
                }
            }


            var sB = d3.select('#change_bins_button');
              

            sLabel.on('click', function(){
                if(graph_type == 'histogram'){
                    histchartTitle = document.getElementById("chartTitle").value;
                    histxAxisLabel = document.getElementById("xAxisLabel").value;
                    histyAxisLabel = document.getElementById("yAxisLabel").value;
                    changeHisto(data, xAxisVar, histxAxisLabel, histyAxisLabel, histchartTitle, binCount); 
                }
            });

            sB.on('click', function(){
                binCount = document.getElementById("histBins").value;
                globalHistBin = binCount;
                if(histXVar!="null" && globalHistBin != ""){
                    changeHisto(data, xAxisVar, histxAxisLabel, histyAxisLabel, histchartTitle, binCount);
                }  
            });
        });


        function changeHisto(data, xAxisVar, xAxisLabel, yAxisLabel, chartTitle, binCount){
            d3.selectAll("svg > *").remove();


            var dataNew;
            var map = data.map(function(d){ return +d[xAxisVar]});

            if(binCount == ""){
                binCount = map.length;
            }

            var histogram = d3.histogram().thresholds(+binCount);

            var bins = histogram(map);


            var maxY = d3.max(bins, function(d) { return d.length; });

            xScale.domain([d3.min(bins, function(d) { return d.x0; }), d3.max(bins, function(d) { return d.x1; })]).nice();

            yScale.domain([0, maxY]).nice();

            var maxXAxisLabelWidth = d3.max(data, function(d){ return d[xAxisVar].length; });

            maxXAxisLabelWidth *= bins.length;


            tempMax = 0;

            if(yScale(maxY) != 0 ){
                tempMax = yScale(maxY);
            }

            var bar = svg.selectAll(".bar")
      .data(bins)
    .enter().append("g")
      .attr("class", "bar")
      .attr("transform", function(d) { return "translate(" + margin.left + "," + margin.bottom + ")"; });

      bar.append("rect")
      .attr("x", function(d){ return xScale(d.x0);})
      .attr("y", function(d){return height - yScale(maxY - d.length) - margin.bottom + tempMax;})
      .attr("width", function(d) { return xScale(d.x1) - xScale(d.x0); })
      .attr("height", function(d) {return yScale(maxY - d.length) - tempMax; })
      .attr("fill", "steelblue")
      .on("mouseenter", function(d) {
              var xPosition = d3.mouse(this)[0];
              var yPosition = d3.mouse(this)[1] - 10;
              tooltip.style("display", "block");
              tooltip.attr("transform", "translate(" + xPosition + "," + yPosition + ")");
              tooltip.select("text").text(d.length);
            })
      .on("mouseout", function() { tooltip.style("display", "none"); })
            .on("mousemove", function(d) {
              var xPosition = d3.mouse(this)[0];
              var yPosition = d3.mouse(this)[1] - 10;
              tooltip.style("display", "block");
              tooltip.attr("transform", "translate(" + xPosition + "," + yPosition + ")");
              tooltip.select("text").text(d.length);
            });

        var xAxis = d3.axisBottom(xScale);
        var yAxis = d3.axisLeft(yScale);


            if(xAxisLabel == ""){
                xAxisLabel = maxUniqueVar;
                histxAxisLabel = maxUniqueVar;
                
            }

            if(yAxisLabel == ""){
                yAxisLabel = "count(" + maxUniqueVar + ")";
                histyAxisLabel = "count(" + maxUniqueVar + ")";
            }

            if(chartTitle == ""){
                chartTitle = secondMaxUniqueVar + " vs " + maxUniqueVar;
                histchartTitle = secondMaxUniqueVar + " vs " + maxUniqueVar;
            }


              if(maxXAxisLabelWidth > 100){
                svg.append("g")
                .attr("class", "x axis")
                .attr("transform", "translate(" + margin.left + "," + height + ")")
                .call(xAxis)
                .selectAll("text")
                    .attr("y", 0)
                    .attr("x", 9)
                    .attr("dy", ".35em")
                    .attr("transform", "rotate(90)")
                    .style("text-anchor", "start");
            }else{
                svg.append("g")
                .attr("class", "x axis")
                .attr("transform", "translate(" + margin.left + "," + height + ")")
                .call(xAxis);
            }

                svg.append("text")             
              .attr("transform","translate(" + (width/2) + " ," + (height + margin.top + 30) + ")")
              .style("text-anchor", "middle")
              .text(xAxisLabel);
              

              svg.append("g")
              .attr("class", "y axis")
            .attr("transform", "translate(" + margin.left + "," + (margin.top + margin.bottom) + ")")
                  .call(yAxis);



                svg.append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", 0)
                .attr("x", 0 - (height / 2))
                .attr("dy", "1em")
                .style("text-anchor", "middle")
                .text(yAxisLabel);

                d3.select('svg').append("text")
                .attr("x", (width / 2))             
                .attr("y", -50)
                .attr("text-anchor", "middle")  
                .style("font-size", "16px") 
                .style("text-decoration", "underline")  
                .style("font-size", "24px")
                .style("font-weight", "bold")
                .text(chartTitle);


                var tooltip = svg.append("g")
            .style("display", "none");
              
            tooltip.append("rect")
            .attr("width", 60)
            .attr("height", 20)
            .attr("fill", "white")
            .style("opacity", 0.5);

            tooltip.append("text")
            .attr("x", 30)
            .attr("dy", "1.2em")
            .style("text-anchor", "middle")
            .attr("font-size", "12px")
            .attr("font-weight", "bold");
        }

    }else if(x == "pie"){

        document.getElementById('histBins').style.display = "none";
        document.getElementById('change_bins_button').style.display = "none";

        document.getElementById('bar_option').style.backgroundColor= "#eaeaea";
        document.getElementById('histogram_option').style.backgroundColor= "#eaeaea";
        document.getElementById('pie_option').style.backgroundColor= "#cccccc";
        document.getElementById('line_option').style.backgroundColor= "#eaeaea";

        d3.select("svg").remove();
        d3.selectAll("select").remove();
        d3.selectAll("br").remove();
        d3.selectAll("input[type='radio']").remove();
        d3.selectAll("input[type='checkbox']").remove();
        d3.selectAll("h6").remove();
        d3.selectAll("label").remove();
        graphType = x;
        
        var margin = {top:0, right:0, bottom:20, left:50},
            width  = 900,
            height = 550,
            radius = Math.min(width, height) / 2;

        var svg = d3.select("#svgcontainer")
            .append("svg:svg")
            .attr("width", "100%")
            .attr("height", "100%")
            .attr("viewBox", "0 0 " + width + " " + height);
        
  

        var xAxisVar = pieXVar;
        var yAxisVar= pieYVar;
        var operation=pieOp;

        if (xAxisVar == "" || xAxisVar == "null" || xAxisVar == null){
            xAxisVar = secondMaxUniqueVar;
            pieXVar = secondMaxUniqueVar;
        }

        if(yAxisVar == "" || yAxisVar == "null" || yAxisVar == null){
            yAxisVar = maxUniqueVar;
            pieYVar = maxUniqueVar;
        }

        if(operation == "" || operation == "null" || operation == null){
            operation = "Sum";
            pieOp = "Sum";
        }

        d3.csv(working_dataset+'?' + Math.floor(Math.random() * 1000), function(error, data){

              var dataValues = d3.values(data)[0];

              var sLabel = d3.select('#change_label_button')
                        .text("Change Label");

                
                d3.select('#chart_variables_list').append('br');


              d3.select('#chart_variables_list_x')
                    .append('h6')
                    .text('X-Axis');

                d3.select('#chart_variables_list_y')
                    .append('h6')
                    .text('Y-Axis');

              for(var i=0; i<Object.keys(dataValues).length; i++ ){
                 d3.select('#chart_variables_list_x')
                    .append('input')
                        .attr('type','radio')
                        .attr('name', 'checkbox_options_x')
                        .attr("id",'xOption'+i)
                        .attr('class', 'checkbox_options_x')
                        .property('value', Object.keys(dataValues)[i]);

                 d3.select('#chart_variables_list_x')
                    .append('label')
                        .text(Object.keys(dataValues)[i])
                        .attr('class', 'checkbox_options_label_x')
                        .style('display', 'inline');
                 d3.select('#chart_variables_list_x')
                    .append('br');

              }

            d3.selectAll(("input[name='checkbox_options_x']")).on("change", function(){
                if(yAxisVar != this.value){
                    xAxisVar = this.value;
                    pieXVar = xAxisVar;
                    if(pieXVar!="null" && pieYVar !="null" && pieOp !="null"){
                        changePie(data, xAxisVar, yAxisVar, operation, piechartTitle);
                    }
                }else{
                    for(var i=0; i<Object.keys(dataValues).length; i++ ){
                        if(document.getElementById('xOption'+i).value == pieXVar){
                            d3.select('#xOption'+i).property('checked', true);      
                        }
                    }
                }
            });



            for(var i=0; i<Object.keys(dataValues).length; i++ ){
                if(document.getElementById('xOption'+i).value == pieXVar){
                    d3.select('#xOption'+i).property('checked', true);
                    if(pieXVar!="null" && pieYVar !="null" && pieOp !="null"){
                        changePie(data, xAxisVar, yAxisVar, operation, piechartTitle);
                    }
                }
            }


            for(var i=0; i<Object.keys(dataValues).length; i++ ){
                 d3.select('#chart_variables_list_y')
                    .append('input')
                        .attr('type','radio')
                        .attr('name', 'checkbox_options_y')
                        .attr("id",'yOption'+i)
                        .attr('class', 'checkbox_options_y')
                        .property('value', Object.keys(dataValues)[i]);

                 d3.select('#chart_variables_list_y')
                    .append('label')
                        .text(Object.keys(dataValues)[i])
                        .attr('class', 'checkbox_options_label_y')
                        .style('display', 'inline');
                 d3.select('#chart_variables_list_y')
                    .append('br');

              }

            d3.selectAll(("input[name='checkbox_options_y']")).on("change", function(){
                if(xAxisVar != this.value){
                    yAxisVar = this.value;
                    pieYVar = yAxisVar;
                    if(pieXVar!="null" && pieYVar !="null" && pieOp !="null"){
                        changePie(data, xAxisVar, yAxisVar, operation, piechartTitle);
                    }
                }else{
                    for(var i=0; i<Object.keys(dataValues).length; i++ ){
                        if(document.getElementById('yOption'+i).value == pieYVar){
                            d3.select('#yOption'+i).property('checked', true);
                        }
                    }
                }
            });


            for(var i=0; i<Object.keys(dataValues).length; i++ ){
                if(document.getElementById('yOption'+i).value == pieYVar){
                    d3.select('#yOption'+i).property('checked', true);
                    if(pieXVar!="null" && pieYVar !="null" && pieOp !="null"){
                        changePie(data, xAxisVar, yAxisVar, operation, piechartTitle);
                    }
                }
            }


            d3.select('#chart_operations_list')
                    .append('h6')
                    .style('margin-top', '30px')
                    .text('Aggregation Function');

            var opArray = ['Sum', 'Average', 'Max', 'Min'];

            for(var i=0; i<4; i++){
                d3.select('#chart_operations_list').append('input')
                    .attr('type','radio')
                    .attr('name', 'checkbox_operations')
                    .attr('class', 'checkbox_operations')
                    .attr('id', 'pieOpOption'+i)
                    .property('value',opArray[i]);
                d3.select('#chart_operations_list')
                        .append('label')
                            .text(opArray[i])
                            .attr('class', 'checkbox_operations_label')
                            .style('display', 'inline');
                 d3.select('#chart_operations_list').append('br'); 
            }


            d3.selectAll(("input[name='checkbox_operations']")).on("change", function(){
                operation = this.value;
                pieOp=operation;
                if(pieXVar!="null" && pieYVar !="null" && pieOp !="null"){
                    changePie(data, xAxisVar, yAxisVar, operation, piechartTitle);
                }
            });

            for(var i=0; i<4; i++ ){
                if(document.getElementById('pieOpOption'+i).value == pieOp){
                    d3.select('#pieOpOption'+i).property('checked', true);
                    if(pieXVar!="null" && pieYVar !="null" && pieOp !="null"){
                        changePie(data, xAxisVar, yAxisVar, operation, piechartTitle);
                    }
                }
            }


            sLabel.on('click', function(){
                if(graph_type == 'pie'){
                    piechartTitle = document.getElementById("chartTitle").value;
                
                    changePie(data, xAxisVar, yAxisVar, operation, piechartTitle);
                }
            });


        });


        function changePie(data, xAxisVar, yAxisVar, operation, chartTitle){
            d3.selectAll("svg > *").remove(); 

            var map; 
            if(operation == "Average") {
              map=d3.nest()
                .key(function(d) {return d[xAxisVar];})
                .rollup(function(d) {
                return d3.mean(d,function(g) {return +g[yAxisVar];});
                })
                .entries(data);
            }else if(operation == "Sum") {
              map=d3.nest()
                .key(function(d) {return d[xAxisVar];})
                .rollup(function(d) {
                return d3.sum(d,function(g) {return +g[yAxisVar];});
                })
                .entries(data);
            }else if(operation == "Max") {
              map=d3.nest()
                .key(function(d) {return d[xAxisVar];})
                .rollup(function(d) {
                return d3.max(d,function(g) {return +g[yAxisVar];});
                })
                .entries(data);
            }else if(operation == "Min") {
              map=d3.nest()
                .key(function(d) {return d[xAxisVar];})
                .rollup(function(d) {
                return d3.min(d,function(g) {return +g[yAxisVar];});
                })
                .entries(data);
            }

            map.sort(function(x, y){
              return d3.descending(+x["value"], +y["value"]);
            })


            if(map.length > 6) {
                var othersAggt = 0;
                newMap=[];
                for(iii=0; iii<6; iii++){
                    newMap.push(map[iii]);
                }
                for(iii=6; iii<map.length; iii++){
                    othersAggt += map[iii]['value'];
                }
                newMap.push({key: "Others", value: othersAggt});
                map = newMap;
            }

            var arc = d3.arc()
                .outerRadius(radius - 10)
                .innerRadius(0);

            var labelArc = d3.arc()
                .outerRadius(radius - 40)
                .innerRadius(radius - 40);

            var pie = d3.pie()
                .sort(null)
                .value(function(d) { return d.value; });

            var newData = pie(map);


            var colorScale = d3.scaleOrdinal(d3.schemeCategory10);
            colorScale.domain(newData.map(function (d){ return d.data.key; }));

            var g = svg.selectAll(".arc")
                .data(newData)
                .enter().append("g")
                .attr("class", "arc")
                .attr("transform", function(d) { return "translate(" + width/2 + "," + height/2 + ")"; });

            g.append("path")
                .attr("d", arc)
                .style("fill", function(d) { return colorScale(d.data.key); })
                .on("mouseenter", function(d) {
                  var xPosition = d3.mouse(this)[0] + width/2 - 25;
                  var yPosition = d3.mouse(this)[1] + height/2 - 25;
                  tooltip.style("display", "block");
                  tooltip.attr("transform", "translate(" + xPosition + "," + yPosition + ")");
                  tooltip.select("text").text(d.data.value);
                })
                .on("mouseout", function() { tooltip.style("display", "none"); })
                .on("mousemove", function(d) {
                  var xPosition = d3.mouse(this)[0] + width/2 -25;
                  var yPosition = d3.mouse(this)[1] + height/2 - 25;
                  tooltip.style("display", "block");
                  tooltip.attr("transform", "translate(" + xPosition + "," + yPosition + ")");
                  tooltip.select("text").text(d.data.key + " : " + +d.data.value.toFixed(3));
                });


            if(chartTitle == ""){
                chartTitle = secondMaxUniqueVar + " vs " + maxUniqueVar;
                piechartTitle = secondMaxUniqueVar + " vs " + maxUniqueVar;
            }


            g.append("text")
                .attr("transform", function(d) {return "translate(" + (labelArc.centroid(d)[0] - 10) + "," + labelArc.centroid(d)[1] + ")"; })
                .text(function(d) { return (((d.endAngle - d.startAngle)/(2*Math.PI)*100).toFixed(1) + "%" );})
                .style("fill", "#eee")
                .style("font-size", "10px");

                d3.select('svg').append("text")
                .attr("x", (width / 2))             
                .attr("y", -50)
                .attr("text-anchor", "middle")  
                .style("font-size", "16px") 
                .style("text-decoration", "underline")  
                .style("font-size", "24px")
                .style("font-weight", "bold")
                .text(chartTitle);


            var legend = svg.append("g")
            .attr("class", "legend")
            .attr("x", width -50 )
            .attr("y", 0)
            .attr("height", 100)
            .attr("width", 100);

          legend.selectAll('g').data(newData)
              .enter()
              .append('g')
              .each(function(d, i) {
                var gg = d3.select(this);
                gg.append("rect")
                  .attr("x", width - 140)
                  .attr("y", i*25)
                  .attr("width", 10)
                  .attr("height", 10)
                  .style("fill", colorScale(d.data.key));

                gg.append("text")
                  .attr("x", width - 125)
                  .attr("y", i * 25 + 10)
                  .attr("height",30)
                  .attr("width",100)
                  .text(d.data.key);

              });


                var tooltip = svg.append("g")
            .style("display", "none");
              
            tooltip.append("rect")
            .attr("width", 100)
            .attr("height", 20)
            .attr("fill", "white")
            .style("opacity", 0.5);

            tooltip.append("text")
            .attr("x", 50)
            .attr("dy", "1.2em")
            .style("text-anchor", "middle")
            .attr("font-size", "12px")
            .attr("font-weight", "bold");
        }

    }else if(x=="line") {

        document.getElementById('histBins').style.display = "none";
        document.getElementById('change_bins_button').style.display = "none";

        document.getElementById('bar_option').style.backgroundColor= "#eaeaea";
        document.getElementById('histogram_option').style.backgroundColor= "#eaeaea";
        document.getElementById('pie_option').style.backgroundColor= "#eaeaea";
        document.getElementById('line_option').style.backgroundColor= "#cccccc";

        d3.selectAll("svg").remove();
        d3.selectAll("select").remove();
        d3.selectAll("br").remove();
        d3.selectAll("input[type='radio']").remove();
        d3.selectAll("input[type='checkbox']").remove();
        d3.selectAll("h6").remove();
        d3.selectAll("label").remove();
        graphType = x;
        
        var margin = {top:0, right:0, bottom:20, left:50},
            width  = 900,
            height = 550;

        var svg = d3.select("#svgcontainer")
            .append("svg:svg")
            .attr("width", "100%")
            .attr("height", "100%")
            .attr("viewBox", "0 0 " + width + " " + height); 

        var yScale = d3.scaleLinear()
            .range([height - margin.top - margin.bottom, 0]);

        var xScale = d3.scaleBand()
            .rangeRound([0, width - margin.right - margin.left]);

        var xAxis = d3.axisBottom(xScale);
        var yAxis = d3.axisLeft(yScale);
  

        var xAxisVar = lineXVar;
        var yAxisVar = lineYVar.slice();
        var operation = lineOp;

        if (xAxisVar == "" || xAxisVar == "null" || xAxisVar == null){
            xAxisVar = secondMaxUniqueVar;
            lineXVar = secondMaxUniqueVar;
        }

        if(!yAxisVar[0]){
            yAxisVar.push(maxUniqueVar);
            lineYVar.push(maxUniqueVar);
        }

        if(operation == "" || operation == "null" || operation == null){
            operation = "Sum";
            lineOp = "Sum";
        }


        d3.csv(working_dataset+'?' + Math.floor(Math.random() * 1000), function(error, data){

              var dataValues = d3.values(data)[0];


              var sLabel = d3.select('#change_label_button')
                        .text("Change Label");

                
                d3.select('#chart_variables_list').append('br');

               d3.select('#chart_variables_list_x')
                    .append('h6')
                    .text('X-Axis');

                d3.select('#chart_variables_list_y')
                    .append('h6')
                    .text('Y-Axis');

              for(var i=0; i<Object.keys(dataValues).length; i++ ){
                 d3.select('#chart_variables_list_x')
                    .append('input')
                        .attr('type','radio')
                        .attr('name', 'checkbox_options_x')
                        .attr("id",'xOption'+i)
                        .attr('class', 'checkbox_options_x')
                        .property('value', Object.keys(dataValues)[i]);

                 d3.select('#chart_variables_list_x')
                    .append('label')
                        .text(Object.keys(dataValues)[i])
                        .attr('class', 'checkbox_options_label_x')
                        .style('display', 'inline');
                 d3.select('#chart_variables_list_x')
                    .append('br');

              }

            d3.selectAll(("input[name='checkbox_options_x']")).on("change", function(){
                var flagii=0;
                for(var ii=0; ii<lineYVar.length; ii++){
                   if(this.value == lineYVar[ii]){
                        flagii=1;
                        break;
                    }
                }
                if(flagii==0){
                    xAxisVar = this.value;
                    lineXVar = xAxisVar;
                    if(lineXVar!="null" && lineYVar[0] !="null" && lineOp !="null"){
                        changeLines(data, xAxisVar, yAxisVar, operation, linexAxisLabel, lineyAxisLabel, linechartTitle);
                    }
                }else{
                    for(var i=0; i<Object.keys(dataValues).length; i++ ){
                        if(document.getElementById('xOption'+i).value == lineXVar){
                            d3.select('#xOption'+i).property('checked', true);
                        }
                    }
                }
            });



            for(var i=0; i<Object.keys(dataValues).length; i++ ){
                if(document.getElementById('xOption'+i).value == lineXVar){
                    d3.select('#xOption'+i).property('checked', true);
                    if(lineXVar!="null" && lineYVar[0] != "null" && lineOp != "null"){
                        changeLines(data, xAxisVar, yAxisVar, operation, linexAxisLabel, lineyAxisLabel, linechartTitle);
                    }
                }
            }


            for(var i=0; i<Object.keys(dataValues).length; i++ ){
                 d3.select('#chart_variables_list_y')
                    .append('input')
                        .attr('type','checkbox')
                        .attr('name', 'checkbox_options_y')
                        .attr("id",'yOption'+i)
                        .attr('class', 'checkbox_options_y')
                        .property('value', Object.keys(dataValues)[i]);

                 d3.select('#chart_variables_list_y')
                    .append('label')
                        .text(Object.keys(dataValues)[i])
                        .attr('class', 'checkbox_options_label_y')
                        .style('display', 'inline');
                 d3.select('#chart_variables_list_y')
                    .append('br');

              }

            d3.selectAll(("input[name='checkbox_options_y']")).on("change", function(){
                if(xAxisVar != this.value){
                    console.log("Here");
                    if(this.checked){
                        yAxisVar.push(this.value);
                        lineYVar.push(this.value);
                    }else{
                        var index = yAxisVar.indexOf(this.value);
                        if (index !== -1){
                            yAxisVar.splice(index, 1);
                        }
                        var index2 = lineYVar.indexOf(this.value);
                        if (index2 !== -1){
                            lineYVar.splice(index, 1);
                        }
                    }
                    if(lineXVar!="null" && lineYVar[0] != "null" && lineOp != "null"){
                        changeLines(data, xAxisVar, yAxisVar, operation, linexAxisLabel, lineyAxisLabel, linechartTitle);
                    }
                }else{
                    d3.select('#'+this.id).property('checked', false);
                }
            });
                      
             d3.select('#chart_operations_list')
                    .append('h6')
                    .style('margin-top', '30px')
                    .text('Aggregation Function');

            for(var i=0; i<Object.keys(dataValues).length; i++ ){
                for(var ii=0; ii<lineYVar.length; ii++){
                   if(document.getElementById('yOption'+i).value == lineYVar[ii]){
                        d3.select('#yOption'+i).property('checked', true);
                        if(lineXVar!="null" && lineYVar[0] != "null" && lineOp != "null"){
                            changeLines(data, xAxisVar, yAxisVar, operation, linexAxisLabel, lineyAxisLabel, linechartTitle);
                        }
                    }
                }
            }

            var opArray = ['Sum', 'Average', 'Max', 'Min'];

            for(var i=0; i<4; i++){
                d3.select('#chart_operations_list').append('input')
                    .attr('type','radio')
                    .attr('name', 'checkbox_operations')
                    .attr('class', 'checkbox_operations')
                    .attr('id','lineOpOption'+i)
                    .property('value',opArray[i]);
                d3.select('#chart_operations_list')
                        .append('label')
                            .text(opArray[i])
                            .attr('class', 'checkbox_operations_label')
                            .style('display', 'inline');
                 d3.select('#chart_operations_list').append('br'); 
            }


            d3.selectAll(("input[name='checkbox_operations']")).on("change", function(){
                operation = this.value;
                lineOp = operation;
                if(lineXVar!="null" && lineYVar[0] != "null" && lineOp != "null"){
                    changeLines(data, xAxisVar, yAxisVar, operation, linexAxisLabel, lineyAxisLabel, linechartTitle);
                }
            });

            for(var i=0; i<4; i++ ){
                if(document.getElementById('lineOpOption'+i).value == lineOp){
                    d3.select('#lineOpOption'+i).property('checked', true);
                    if(lineXVar!="null" && lineYVar[0] != "null" && lineOp != "null"){
                        changeLines(data, xAxisVar, yAxisVar, operation, linexAxisLabel, lineyAxisLabel, linechartTitle);
                    }
                }
            }

            sLabel.on('click', function(){
                if(graph_type == 'line'){
                    linechartTitle = document.getElementById("chartTitle").value;
                    linexAxisLabel = document.getElementById("xAxisLabel").value;
                    lineyAxisLabel = document.getElementById("yAxisLabel").value;
                    changeLines(data, xAxisVar, yAxisVar, operation, linexAxisLabel, lineyAxisLabel, linechartTitle);
                }
            });

        });

        function changeLines(data, xAxisVar, yAxisVar, operation, xAxisLabel, yAxisLabel, chartTitle){
          d3.selectAll("svg > *").remove();

            var dataNew;

            if(yAxisVar[0]){
                if(operation == "Average") {
                  dataNew=d3.nest()
                    .key(function(d) {return d[xAxisVar];})
                    .rollup(function(d) {
                    return d3.mean(d,function(g) {return +g[yAxisVar[0]];});
                    })
                    .entries(data);
                }else if(operation == "Sum") {
                  dataNew=d3.nest()
                    .key(function(d) {return d[xAxisVar];})
                    .rollup(function(d) {
                    return d3.sum(d,function(g) {return +g[yAxisVar[0]];});
                    })
                    .entries(data);
                }else if(operation == "Max") {
                  dataNew=d3.nest()
                    .key(function(d) {return d[xAxisVar];})
                    .rollup(function(d) {
                    return d3.max(d,function(g) {return +g[yAxisVar[0]];});
                    })
                    .entries(data);
                }else if(operation == "Min") {
                  dataNew=d3.nest()
                    .key(function(d) {return d[xAxisVar];})
                    .rollup(function(d) {
                    return d3.min(d,function(g) {return +g[yAxisVar[0]];});
                    })
                    .entries(data);
                }

                dataNew.sort(function(x, y){
                  return d3.ascending(+x["key"], +y["key"]);
                })
   
            var maxYAxisDom = d3.max(dataNew, function(d){ return d["value"]; });


            yScale.domain([0, maxYAxisDom]).nice();

            xScale.domain(dataNew.map(function(d){ return d["key"]; }));

            var maxXAxisLabelWidth = d3.max(data, function(d){ return d[xAxisVar].length; });

            maxXAxisLabelWidth *= dataNew.length;

            svg.select('.y_axis').remove();

            if(xAxisLabel == ""){
                xAxisLabel = secondMaxUniqueVar;
                linexAxisLabel = secondMaxUniqueVar;
                
            }

            if(yAxisLabel == ""){
                yAxisLabel = maxUniqueVar;
                lineyAxisLabel = maxUniqueVar;
            }

            if(chartTitle == ""){
                chartTitle = secondMaxUniqueVar + " vs " + maxUniqueVar;
                linechartTitle = secondMaxUniqueVar + " vs " + maxUniqueVar;
            }

            svg.append("g")
            .attr("class", "y_axis")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
            .call(yAxis);

            svg.append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", 0)
                .attr("x", 0 - (height / 2))
                .attr("dy", "1em")
                .style("text-anchor", "middle")
                .text(yAxisLabel);

        //adding x axis to the bottom of chart
            if(maxXAxisLabelWidth > 100){
                svg.append("g")
                .attr("class", "x axis")
                .attr("transform", "translate(" + margin.left + "," + (height - margin.bottom) + ")")
                .call(xAxis)
                .selectAll("text")
                    .attr("y", 0)
                    .attr("x", 9)
                    .attr("dy", ".35em")
                    .attr("transform", "rotate(90)")
                    .style("text-anchor", "start");
            }else{
                svg.append("g")
                .attr("class", "x axis")
                .attr("transform", "translate(" + margin.left + "," + (height - margin.bottom) + ")")
                .call(xAxis);
            }

            svg.append("text")             
              .attr("transform","translate(" + (width/2) + " ," + (height + margin.top + 20) + ")")
              .style("text-anchor", "middle")
              .text(xAxisLabel);

            d3.select('svg').append("text")
                .attr("x", (width / 2))             
                .attr("y", -50)
                .attr("text-anchor", "middle")  
                .style("font-size", "16px") 
                .style("text-decoration", "underline")  
                .style("font-size", "24px")
                .style("font-weight", "bold")
                .text(chartTitle);

            var tooltip = svg.append("g")
            .style("display", "none");
              
            tooltip.append("rect")
            .attr("width", 60)
            .attr("height", 20)
            .attr("fill", "#aeaeae")
            .style("opacity", 0.5);

            tooltip.append("text")
            .attr("x", 30)
            .attr("dy", "1.2em")
            .attr("color", "#888")
            .style("text-anchor", "middle")
            .attr("font-size", "12px")
            .attr("font-weight", "bold");
          
        }

            var dataArray = [];


            for(var ii=0; ii<yAxisVar.length; ii++){


                var lineGen = d3.line()
              .x(function(d) {
                return xScale(d["key"]) ;
              })
              .y(function(d) {
                return yScale(d["value"]);
              });


                if(operation == "Average") {
              dataNew=d3.nest()
                .key(function(d) {return d[xAxisVar];})
                .rollup(function(d) {
                return d3.mean(d,function(g) {return +g[yAxisVar[ii]];});
                })
                .entries(data);
            }else if(operation == "Sum") {
              dataNew=d3.nest()
                .key(function(d) {return d[xAxisVar];})
                .rollup(function(d) {
                return d3.sum(d,function(g) {return +g[yAxisVar[ii]];});
                })
                .entries(data);
            }else if(operation == "Max") {
              dataNew=d3.nest()
                .key(function(d) {return d[xAxisVar];})
                .rollup(function(d) {
                return d3.max(d,function(g) {return +g[yAxisVar[ii]];});
                })
                .entries(data);
            }else if(operation == "Min") {
              dataNew=d3.nest()
                .key(function(d) {return d[xAxisVar];})
                .rollup(function(d) {
                return d3.min(d,function(g) {return +g[yAxisVar[ii]];});
                })
                .entries(data);
            }

            dataNew.sort(function(x, y){
              return d3.ascending(+x["key"], +y["key"]);
            })

            dataArray.push(dataNew);

            if(d3.max(dataNew, function(d){ return d["value"]; }) > maxYAxisDom){

                maxYAxisDom = d3.max(dataNew, function(d){ return d["value"];});
                d3.select(".y_axis").remove();

                yScale.domain([0, maxYAxisDom]).nice();
                svg.append("g")
            .attr("class", "y_axis")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
            .call(yAxis);

            svg.append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", 0)
                .attr("x", 0 - (height / 2))
                .attr("dy", "1em")
                .style("text-anchor", "middle")
                .text(yAxisLabel);
            }
        }

             var colorScale = d3.scaleOrdinal(d3.schemeCategory10);
            colorScale.domain([0, dataArray.length-1]);

            var g = svg.selectAll(".graphLines")
                .data(dataArray).enter()
                .append("g")
                .attr("class", "graphLines");


            g.append("path")
                .attr("transform", "translate(" + margin.left + "," + (margin.top + 7) +  ")")
                .attr("d", function(d){ return lineGen(d);})
                .attr("stroke", function(d, i){return colorScale(i);})
                .attr("stroke-width", 2)
                .attr("fill", "none")    
                .on("mouseout", function() { tooltip.style("display", "none"); }) 
                .on("mousemove", function(d) {
                  var xPosition = d3.mouse(this)[0];
                  var yPosition = d3.mouse(this)[1];
                  var value = yScale.invert(yPosition);
                  tooltip.style("display", "block");
                  tooltip.attr("transform", "translate(" + xPosition + "," + (d3.mouse(this)[1] -25 + ")"));
                  tooltip.select("text").text( (+value).toFixed(3));
                });
             

                var legend = svg.append("g")
    .attr("class", "legend")
    .attr("x", width -150 )
    .attr("y", 0)
    .attr("height", 100)
    .attr("width", 100);

  legend.selectAll('g').data(dataArray)
      .enter()
      .append('g')
      .each(function(d, i) {
        var gg = d3.select(this);
        gg.append("rect")
          .attr("x", width - 150)
          .attr("y", i*25)
          .attr("width", 10)
          .attr("height", 10)
          .style("fill", colorScale(i));

        gg.append("text")
          .attr("x", width - 135)
          .attr("y", i * 25 + 10)
          .attr("height",30)
          .attr("width",100)
          .text(yAxisVar[i]);

      });

            
            

}
    }
}

</script>







  </body>
</html>